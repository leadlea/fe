name: CI (TR check) & Pages deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'out/**'
      - 'docs/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'out/**'
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  TR_TOLERANCE: "0.01"  # 1%

jobs:
  tr-consistency:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check files exist
        run: |
          test -f out/B_full/drive_list.csv || (echo "::error file=out/B_full/drive_list.csv::missing" && exit 1)
          test -f out/B_full/xfmr_list.csv  || (echo "::error file=out/B_full/xfmr_list.csv::missing" && exit 1)

      - name: Validate transformer consistency
        run: |
          python - <<'PY'
          import pandas as pd, sys, os
          tol = float(os.getenv("TR_TOLERANCE","0.01"))
          dr = pd.read_csv("out/B_full/drive_list.csv")
          xf = pd.read_csv("out/B_full/xfmr_list.csv")
          if "入力kVA(概算)" not in dr.columns:
              print("::error :: column '入力kVA(概算)' not found in drive_list.csv"); sys.exit(1)
          s = pd.to_numeric(dr["入力kVA(概算)"], errors="coerce").sum()
          b = float(xf["合算kVA(素)"].iloc[0])
          rel = abs(s - b) / max(1.0, b)
          print(f"sum_kva={s:.3f} base_kva={b:.3f} rel_diff={rel:.4%}")
          if rel > tol:
              print("::error :: Transformer base kVA mismatch (> tolerance)"); sys.exit(2)
          PY

  build-and-deploy:
    needs: tr-consistency
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      pages: write
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Prepare docs (copy out → docs/out)
        run: |
          mkdir -p docs/out
          rsync -av --delete out/ docs/out/ || true
          if [ -f docs/executive_summary.html ]; then
            sed -i.bak 's|\.\./out/|out/|g' docs/executive_summary.html
          fi

      # MermaidのSVG化は wiring.md がある場合だけ実行
      - name: Setup Node for Mermaid
        if: ${{ hashFiles('docs/out/B_full/wiring.md') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Render Mermaid to SVG
        if: ${{ hashFiles('docs/out/B_full/wiring.md') != '' }}
        run: |
          npm i -g @mermaid-js/mermaid-cli
          sed -n '/```mermaid/,/```/p' docs/out/B_full/wiring.md | sed '1d;$d' > docs/out/B_full/wiring.mmd
          mmdc -i docs/out/B_full/wiring.mmd -o docs/out/B_full/wiring.svg

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4


name: CI (TR check) & Pages deploy

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '.venv/**'
      - 'out_edits/**'
      - 'certs/**'
      - '*.zip'
      - '*.key'
      - '*.crt'
      - '*.csr'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '.venv/**'
      - 'out_edits/**'
      - 'certs/**'
      - '*.zip'
      - '*.key'
      - '*.crt'
      - '*.csr'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  TR_TOLERANCE: "0.01"  # 1%

jobs:
  tr-consistency:
    name: TR consistency (∑kVA vs base kVA)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install pandas
        run: pip install --disable-pip-version-check pandas

      # out がある時だけチェックを実施
      - name: Detect out files
        id: detect
        run: |
          if [ -f out/B_full/drive_list.csv ] && [ -f out/B_full/xfmr_list.csv ]; then
            echo "has_out=true" >> $GITHUB_OUTPUT
          else
            echo "has_out=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate transformer consistency
        if: steps.detect.outputs.has_out == 'true'
        run: |
          python - <<'PY'
          import pandas as pd, sys
          from pathlib import Path
          tol = float("${{ env.TR_TOLERANCE }}")
          dr = pd.read_csv("out/B_full/drive_list.csv")
          xf = pd.read_csv("out/B_full/xfmr_list.csv")
          if "入力kVA(概算)" not in dr.columns:
              print("::error :: column '入力kVA(概算)' not found"); sys.exit(1)
          s = pd.to_numeric(dr["入力kVA(概算)"], errors="coerce").sum()
          b = float(xf["合算kVA(素)"].iloc[0])
          rel = abs(s - b) / max(1.0, b)
          print(f"sum_kva={s:.3f} base_kva={b:.3f} rel_diff={rel:.4%}")
          if rel > tol:
              print("::error :: Transformer base kVA mismatch (> tolerance)"); sys.exit(2)
          PY

  build-and-deploy:
    name: Build & Deploy Pages
    needs: tr-consistency
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      pages: write
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Prepare docs (copy out → docs/out, add root files)
        run: |
          mkdir -p docs/out
          rsync -av --delete out/ docs/out/ || true
          # ルートの hitl.html / README.md も公開物へ
          [ -f hitl.html ] && cp hitl.html docs/
          [ -f README.md ] && cp README.md docs/README.md
          # 既存の相対パス調整（必要なら）
          if [ -f docs/executive_summary.html ]; then
            sed -i 's|\.\./out/|out/|g' docs/executive_summary.html
          fi

      # README.md をHTMLにしたい場合（任意）
      - name: Convert README.md -> README.html (optional)
        if: ${{ hashFiles('README.md') != '' }}
        uses: docker://pandoc/core:2.19
        with:
          args: -f gfm -t html5 -s -o docs/README.html README.md

      # Mermaid 変換は従来通り
      - name: Setup Node for Mermaid
        if: ${{ hashFiles('docs/out/B_full/wiring.md') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install mermaid-cli
        if: ${{ hashFiles('docs/out/B_full/wiring.md') != '' }}
        run: npm i -g @mermaid-js/mermaid-cli

      - name: Write puppeteer config (no-sandbox)
        if: ${{ hashFiles('docs/out/B_full/wiring.md') != '' }}
        run: |
          cat > puppeteer-config.json <<'JSON'
          { "args": ["--no-sandbox", "--disable-setuid-sandbox"] }
          JSON

      - name: Render Mermaid to SVG
        if: ${{ hashFiles('docs/out/B_full/wiring.md') != '' }}
        continue-on-error: true
        run: |
          sed -n '/```mermaid/,/```/p' docs/out/B_full/wiring.md | sed '1d;$d' > docs/out/B_full/wiring.mmd
          mmdc -p puppeteer-config.json -i docs/out/B_full/wiring.mmd -o docs/out/B_full/wiring.svg

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4


<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>富士電機 AI推進PoC — エグゼクティブサマリー</title>
  <style>
    :root {
      --bg: #0f1221;
      --card: #171a2b;
      --ink: #e9ecf1;
      --ink-dim: #b8bfd1;
      --acc: #7dd3fc;
      --ok: #34d399;
      --warn: #f59e0b;
      --bad: #f87171;
      --muted: #2a2f45;
    }
    * { box-sizing: border-box; }
    body {
      background: var(--bg);
      color: var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', 'Yu Gothic UI', sans-serif;
      margin: 0; padding: 24px;
      line-height: 1.6;
    }
    h1, h2 { line-height: 1.2; }
    h1 { font-size: 28px; margin: 0 0 8px; }
    h2 { font-size: 18px; margin: 24px 0 8px; color: var(--ink); }
    p.lead { color: var(--ink-dim); margin-top: 0; }
    .grid { display: grid; gap: 16px; grid-template-columns: repeat(12, 1fr); }
    .card {
      background: linear-gradient(180deg, var(--card), #121529);
      border: 1px solid var(--muted);
      border-radius: 16px;
      padding: 16px 18px;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
    }
    .span-6 { grid-column: span 6; }
    .span-4 { grid-column: span 4; }
    .span-8 { grid-column: span 8; }
    .span-12 { grid-column: span 12; }
    .kpi { display: grid; grid-template-columns: repeat(6,1fr); gap: 12px; }
    .kpi .item { background: rgba(255,255,255,0.02); padding: 12px; border-radius: 12px; border:1px solid var(--muted); }
    .kpi .label { font-size: 12px; color: var(--ink-dim); }
    .kpi .value { font-size: 18px; font-weight: 700; margin-top: 2px; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--muted); color:var(--ink-dim); }
    table { width: 100%; border-collapse: collapse; font-size:14px; }
    th, td { padding: 8px 10px; border-bottom: 1px solid var(--muted); }
    th { text-align: left; color: var(--ink-dim); font-weight: 600; }
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .bad { color: var(--bad); }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace; background: #101425; padding: 2px 6px; border-radius: 6px; border:1px solid var(--muted); }
    .section { margin-top: 8px; }
    .footnote { color: var(--ink-dim); font-size: 12px; }
    .list { margin: 0; padding-left: 18px; }
    .mermaid { background: #0f1327; border-radius: 12px; padding: 8px; border:1px solid var(--muted); }
    @media (max-width: 960px) {
      .span-6, .span-4, .span-8, .span-12 { grid-column: span 12; }
      .kpi { grid-template-columns: repeat(2,1fr); }
    }
  </style>
  <!-- Mermaid (works on GitHub Pages) -->
  <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: true, theme: 'dark' });</script>
</head>
<body>
  <header>
    <h1>富士電機 AI推進PoC — エグゼクティブサマリー</h1>
    <p class="lead">OCR＋ルール中心の既存ラインに、LLMチップを“非破壊に挿入”。抽出精度、説明可能性、SKU着地を強化しました。</p>
  </header>

  <section class="grid">
    <div class="card span-8">
      <h2>パイプライン（LLMチップ入り）</h2>
      <div class="mermaid">
      flowchart LR
        A[OCR<br/>fe_list.csv] --> H[LLM見出し正規化<br/>llm_header_map.py]
        H --> F[LLM行フィクサー<br/>llm_fix_rows.py]
        F --> L[LLM重負荷判定 理由付<br/>heavy_from_llm.py]
        L --> S[自動選定+根拠文<br/>size_from_fe_auto.py]
        S --> Q[LLMアノマリ要約<br/>anomaly_from_llm.py]
        S --> K[SKUランク Top3<br/>sku_map_llm.py]
        S --> D[結線図 Mermaid<br/>wiring.md/svg]
        class A,H,F,L,S,Q,K,D node;
      </div>
      <p class="footnote">※ 従来の <span class="code">size_from_fe.py</span> も併用可（非破壊拡張）。</p>
    </div>

    <div class="card span-4">
      <h2>KPI（集中案B_full）</h2>
      <div class="kpi">
        <div class="item"><div class="label">台数</div><div class="value" id="kpi-count">—</div></div>
        <div class="item"><div class="label">総出力 (kW)</div><div class="value" id="kpi-sumkw">—</div></div>
        <div class="item"><div class="label">総入力 (kVA)</div><div class="value" id="kpi-sumkva">—</div></div>
        <div class="item"><div class="label">重負荷比</div><div class="value" id="kpi-heavy">—</div></div>
        <div class="item"><div class="label">推奨TR (kVA)</div><div class="value" id="kpi-tr">—</div></div>
        <div class="item"><div class="label">SKUカバー率</div><div class="value" id="kpi-sku">—</div></div>
      </div>
      <p class="footnote">※ 下記のCSVを自動読込：<span class="code">out/B_full/drive_list.csv</span>, <span class="code">out/B_full/xfmr_list.csv</span>, <span class="code">out/B_full/sku_candidates_llm.csv</span>, <span class="code">out/QC/qc_anomaly_llm.csv</span></p>
    </div>

    <div class="card span-12">
      <h2>LLMの使いどころ（勘所）と効果</h2>
      <table>
        <thead><tr><th>チップ</th><th>使いどころ（入力）</th><th>出力／制約</th><th>期待効果（実績）</th></tr></thead>
        <tbody>
          <tr>
            <td><b>見出しマッピング</b><br><span class="badge">llm_header_map.py</span></td>
            <td>列名のゆらぎ（容量/出力/kW、r/m → rpm、etc）</td>
            <td>正規化マップ(JSON)＋整形CSV</td>
            <td>レイアウト差分に強い。ルール保守の手間↓</td>
          </tr>
          <tr>
            <td><b>行フィクサー</b><br><span class="badge">llm_fix_rows.py</span></td>
            <td>数字崩れ・桁/単位ミス・用途ギブリッシュ</td>
            <td>JSONスキーマ準拠の厳格出力（Pydantic検証）</td>
            <td>kW/rpm/用途の充足率↑、手修正時間↓</td>
          </tr>
          <tr>
            <td><b>重負荷判定（説明付き）</b><br><span class="badge">heavy_from_llm.py</span></td>
            <td>用途テキスト＋数値（rpm/トルク）</td>
            <td>「重負荷/標準」＋根拠文</td>
            <td>マージン自動切替の納得感↑</td>
          </tr>
          <tr>
            <td><b>アノマリ要約</b><br><span class="badge">anomaly_from_llm.py</span></td>
            <td>あり得ない組合せの検出（IF/LOF等）</td>
            <td>日本語で“どこが変か”説明</td>
            <td>QC見逃し防止、レビュー時間↓</td>
          </tr>
          <tr>
            <td><b>SKUランク</b><br><span class="badge">sku_map_llm.py</span></td>
            <td>丸めたkW/電圧/周波数</td>
            <td>実在SKUのTop3＋理由(why)</td>
            <td>机上→型番へ最短導線、購買会話が速い</td>
          </tr>
          <tr>
            <td><b>根拠文生成</b><br><span class="badge">size_from_fe_auto.py --explain</span></td>
            <td>行ごとの計算（PF/η/余裕×丸め）</td>
            <td>日本語の設計根拠</td>
            <td>承認＆監査で強い</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="card span-6">
      <h2>差分の可視化（Before→After）</h2>
      <p>例：<span class="code">out/5/diff_fix_sonnet_full.csv</span> から代表例を抽出して表示します。</p>
      <table id="diff-table"><thead><tr><th>項目</th><th>Before → After</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="card span-6">
      <h2>結線図（Mermaid）</h2>
      <div class="mermaid" id="wiring-mermaid">
      %% ここに out/B_full/wiring.md の mermaid 部分を貼るか、build時に置換
      flowchart LR
        TX[Transformer 500 kVA]:::tx
        TX --> INV1:::inv
        INV1 --> M1:::m
        INV1[VFD 55 kW]
        M1[スタンド 45 kW]
        classDef tx fill:#f5f2f5,stroke:#333,stroke-width:1px;
        classDef inv fill:#eef,stroke:#333,stroke-width:1px;
        classDef m fill:#efe,stroke:#333,stroke-width:1px;
      </div>
      <p class="footnote">※ 実ファイルのコードブロックに差し替え可能（CIで自動反映推奨）。</p>
    </div>

    <div class="card span-12">
      <h2>再現手順（Repro）</h2>
      <ol class="list">
        <li><span class="code">make all</span>（Bedrockのクレデンシャル設定後）</li>
        <li>成果物Zip：<span class="code">out/B_full/poc_bundle_full.zip</span></li>
        <li>ダッシュボード（本ページ）：<span class="code">docs/executive_summary.html</span> を GitHub Pages で公開</li>
      </ol>
      <p class="footnote">AWSキーは必ず環境変数やプロファイルで注入。<b>リポジトリには書かない</b>こと。</p>
    </div>
  </section>

<script>
// --- Lightweight CSV loader (UTF-8/BOM tolerant) ---
async function loadCSV(path) {
  try {
    const res = await fetch(path);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    let text = await res.text();
    // strip BOM
    if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
    const lines = text.trim().split(/\r?\n/);
    const header = lines[0].split(",");
    const rows = lines.slice(1).map(l => {
      // naive CSV split; if you expect quoted commas, replace with a solid CSV parser
      const cells = l.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/);
      const obj = {};
      header.forEach((h,i)=>obj[h.replace(/^"+|"+$/g,"")] = (cells[i]||"").replace(/^"+|"+$/g,""));
      return obj;
    });
    return {header, rows};
  } catch (e) {
    console.warn("CSV load failed", path, e);
    return null;
  }
}
function num(x){ const n = Number(x); return isFinite(n)?n:NaN; }
function pct(p){ return isFinite(p)? (p*100).toFixed(0)+'%':'—'; }

(async function(){
  // base paths (adjust if you host HTML in /docs and CSVs in /out)
  const baseOut = "../out/B_full/";
  const baseQC  = "../out/QC/";

  const drives = await loadCSV(baseOut + "drive_list.csv");
  const xfmr   = await loadCSV(baseOut + "xfmr_list.csv");
  const sku    = await loadCSV(baseOut + "sku_candidates_llm.csv");
  const qc     = await loadCSV(baseQC + "qc_anomaly_llm.csv");

  // KPIs
  if (drives && drives.rows.length){
    const n = drives.rows.length;
    const sumkw = drives.rows.reduce((a,r)=>a+ (num(r["出力(kW)"])||0), 0);
    const sumkva= drives.rows.reduce((a,r)=>a+ (num(r["入力kVA(概算)"])||0), 0);
    const heavy = drives.rows.filter(r=> (r["負荷区分"]||"").includes("重負荷")).length;
    document.getElementById("kpi-count").textContent = n;
    document.getElementById("kpi-sumkw").textContent = sumkw.toFixed(1);
    document.getElementById("kpi-sumkva").textContent= sumkva.toFixed(1);
    document.getElementById("kpi-heavy").textContent = `${heavy}/${n}`;
  }
  if (xfmr && xfmr.rows.length){
    const tr = xfmr.rows[0]["推奨変圧器容量(kVA)"];
    document.getElementById("kpi-tr").textContent = tr || "—";
  }
  if (sku && sku.rows.length && drives){
    const covered = new Set(sku.rows.map(r=>r["row"])).size;
    const n = drives.rows.length;
    document.getElementById("kpi-sku").textContent = n? Math.round(covered*100/n)+"%" : "—";
  }
  if (qc){
    // Could display qc count if needed
  }

  // Diff preview (take first row from out/5/diff_fix_sonnet_full.csv if present)
  const diff = await loadCSV("../out/5/diff_fix_sonnet_full.csv");
  if (diff && diff.rows.length){
    const tbody = document.querySelector("#diff-table tbody");
    const pick = diff.rows[0];
    for (const k of Object.keys(pick)){
      if (/_before$/.test(k)){
        const base = k.replace(/_before$/, "");
        const before = pick[base+"_before"];
        const after  = pick[base+"_after"];
        if (before !== after){
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${base}</td><td>${before} → <b>${after}</b></td>`;
          tbody.appendChild(tr);
        }
      }
    }
  }
})();
</script>
</body>
</html>

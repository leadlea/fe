<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HITL Orchestrator MVP</title>
<style>
  body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;background:#0f172a;color:#e5e7eb}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #334155;background:#0b1224;position:sticky;top:0}
  input,button{font-size:14px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  main{display:grid;grid-template-columns:320px 1fr 420px;gap:16px;padding:16px}
  section,aside{border:1px solid #334155;border-radius:12px;background:rgba(255,255,255,0.02);padding:12px;min-height:200px}
  h3{margin:.2em 0 .6em 0}
  .drop{border:2px dashed #475569;border-radius:12px;padding:24px;text-align:center;color:#94a3b8}
  .drop.drag{background:rgba(34,211,238,.08);border-color:#22d3ee;color:#22d3ee}
  .steps .card{border:1px solid #334155;border-radius:10px;margin-bottom:8px;padding:8px}
  .steps .card .head{display:flex;align-items:center;gap:8px}
  .btn{border:1px solid #334155;background:#0b1224;color:#e5e7eb;border-radius:8px;padding:6px 10px;cursor:pointer}
  .btn.primary{background:#22d3ee;color:#0b1224;border-color:#22d3ee}
  .log{white-space:pre-wrap;background:#0b1224;border:1px solid #334155;border-radius:8px;padding:8px;max-height:180px;overflow:auto}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border-bottom:1px dashed #1f2a40;padding:6px 8px}
  th{position:sticky;top:0;background:#0b1224}
  td[contenteditable="true"]{outline:none}
  td:focus{box-shadow: inset 0 0 0 2px #a78bfa}
  .mermaid{background:#0b1224;border-radius:8px;overflow:auto}
  .hint{font-size:12px;color:#94a3b8}
</style>
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>mermaid.initialize({ startOnLoad: false, securityLevel: 'loose' });</script>
<header>
  <div class="row">
    <b>HITL Orchestrator MVP</b>
    <span class="hint">PDF→パイプライン→CSV編集→再実行→図面</span>
  </div>
  <div class="row">
    <label>API BASE</label>
    <input id="api" size="32" value="https://localhost:8443">
    <button class="btn" onclick="saveApi()">Save</button>
  </div>
</header>
<main>
  <section>
    <h3>1) PDFをドロップ</h3>
    <div id="drop" class="drop">ここにPDFをドロップ</div>
    <div class="hint">run_id: <span id="runid">-</span></div>
    <hr>
    <h3>2) ステップ</h3>
    <div id="steps" class="steps"></div>
  </section>
  <section>
    <h3>3) CSVエディタ</h3>
    <div class="row">
      <input id="csvPath" size="40" placeholder="例: out/run-YYYYMMDD-HHMMSS/fe_list_norm.csv">
      <button class="btn" onclick="loadCSV()">読込</button>
      <button class="btn primary" onclick="saveCSV()">保存</button>
    </div>
    <div id="csvWrap" style="margin-top:8px; border:1px solid #334155; border-radius:10px; overflow:auto; max-height:60vh"></div>
  </section>
  <aside>
    <h3>4) 図面(Mermaid)</h3>
    <div class="row">
      <input id="mmdPath" size="36" placeholder="例: out/B_full/wiring.md">
      <button class="btn" onclick="loadMermaid()">読込</button>
    </div>
    <div id="mmd" class="mermaid" style="margin-top:8px; padding:8px; max-height:65vh"></div>
  </aside>
</main>
<script>
const $ = (s)=>document.querySelector(s);
const api = ()=> localStorage.getItem('apiBase') || $('#api').value || location.origin;
function saveApi(){ localStorage.setItem('apiBase',$('#api').value); alert('saved'); }
$('#api').value = api();

// Load config
let STEPS = [];
fetch(api()+"/api/config").then(r=>r.json()).then(j=>{
  STEPS = j.steps || [];
  renderSteps();
});

// Drag&Drop
const drop = $('#drop');
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('drag'); });
drop.addEventListener('dragleave', e=>{ drop.classList.remove('drag'); });
drop.addEventListener('drop', async e=>{
  e.preventDefault(); drop.classList.remove('drag');
  const f = e.dataTransfer.files[0];
  if(!f){ alert('ファイルがありません'); return; }
  if(!f.name.toLowerCase().endsWith('.pdf')){ alert('PDFを選んでください'); return; }
  const fd = new FormData(); fd.append('file', f);
  const res = await fetch(api()+"/api/upload_pdf",{method:'POST', body: fd});
  const j = await res.json();
  if(!j.ok){ alert('アップロード失敗'); return; }
  window.runId = j.run_id;
  $('#runid').textContent = window.runId;
  renderSteps();
});

function renderSteps(){
  const wrap = $('#steps'); wrap.innerHTML = '';
  if(!STEPS.length){ wrap.textContent = 'ステップが未定義です（pipeline.json を作成するか、既存スクリプトを同じフォルダに置いてください）'; return; }
  STEPS.forEach((s,idx)=>{
    const card = document.createElement('div'); card.className='card';
    const head = document.createElement('div'); head.className='head';
    head.innerHTML = `<b>${s.name}</b> <code style="font-size:12px;color:#94a3b8">${s.cmd}</code>`;
    const btn = document.createElement('button'); btn.className='btn primary'; btn.textContent='実行';
    btn.onclick = ()=> execStep(idx, s.name);
    head.appendChild(btn);
    card.appendChild(head);
    const log = document.createElement('div'); log.className='log'; log.id = `log-${s.name}`; log.textContent='(ログなし)';
    card.appendChild(log);
    wrap.appendChild(card);
  });
}

async function execStep(idx, name){
  if(!window.runId){ alert('先にPDFをドロップしてください'); return; }
  const r = await fetch(api()+"/api/exec_step", {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({run_id: window.runId, step_index: idx})});
  const j = await r.json();
  document.getElementById(`log-${name}`).textContent = j.log || '(no log)';
  if(!j.ok){ alert(`ステップ失敗(exit=${j.exit_code}). コマンドを確認してください。`); }
  else{ alert('OK'); }
}

function parseCSV(text){
  const rows = []; let row = []; let cur = ''; let q=false;
  for(let i=0;i<text.length;i++){ const ch=text[i], nx=text[i+1];
    if(q){ if(ch=='"' && nx=='"'){cur+='"'; i++;} else if(ch=='"'){q=false;} else {cur+=ch;} }
    else { if(ch=='"'){q=true;} else if(ch==','){row.push(cur);cur='';} else if(ch=='\n'){row.push(cur);rows.push(row);row=[];cur='';} else if(ch=='\r'){ } else {cur+=ch;} }
  } if(cur.length||row.length){row.push(cur);rows.push(row);} return rows;
}
function toCSV(rows){ const esc=v=>{const s=(v??'').toString(); return /[",\n\r]/.test(s)?'"'+s.replaceAll('"','""')+'"':s}; return rows.map(r=>r.map(esc).join(',')).join('\n'); }

async function loadCSV(){
  const p = $('#csvPath').value.trim(); if(!p){ alert('pathを入力'); return; }
  const r = await fetch(api()+"/api/read_csv?path="+encodeURIComponent(p));
  if(!r.ok){ alert('読込失敗'); return; }
  const text = await r.text();
  const rows = parseCSV(text);
  renderTable(rows);
}
function renderTable(rows){
  const wrap = $('#csvWrap'); wrap.innerHTML='';
  const tbl = document.createElement('table');
  const thead = document.createElement('thead'); const thr=document.createElement('tr');
  rows[0].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; thr.appendChild(th); });
  thead.appendChild(thr); tbl.appendChild(thead);
  const tbody = document.createElement('tbody');
  for(let i=1;i<rows.length;i++){ const tr=document.createElement('tr');
    rows[i].forEach((c,j)=>{ const td=document.createElement('td'); td.contentEditable='true'; td.textContent=c; td.dataset.r=i; td.dataset.c=j; tr.appendChild(td); });
    tbody.appendChild(tr);
  }
  tbl.appendChild(tbody); wrap.appendChild(tbl);
  wrap.dataset.rows = JSON.stringify(rows);
}
async function saveCSV(){
  const p = $('#csvPath').value.trim(); if(!p){ alert('pathを入力'); return; }
  const wrap = $('#csvWrap'); if(!wrap.dataset.rows){ alert('先に読込'); return; }
  // Reconstruct rows from DOM
  const tbl = wrap.querySelector('table'); const rows=[];
  const headers=[...tbl.querySelectorAll('thead th')].map(th=>th.textContent||''); rows.push(headers);
  tbl.querySelectorAll('tbody tr').forEach(tr=>{
    const r=[]; tr.querySelectorAll('td').forEach(td=> r.push(td.textContent||'')); rows.push(r);
  });
  const csv = toCSV(rows);
  const r = await fetch(api()+"/api/save_csv",{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({path:p, csv})});
  const j = await r.json(); if(j.ok){ alert('保存OK: '+j.path); } else { alert('保存失敗'); }
}

async function loadMermaid(){
  const p = $('#mmdPath').value.trim(); if(!p){ alert('pathを入力'); return; }
  const r = await fetch(api()+"/api/read_text?path="+encodeURIComponent(p));
  if(!r.ok){ alert('読み込み失敗'); return; }
  const text = await r.text();
  // Extract ```mermaid ... ``` if present
  const m = text.match(/```mermaid([\s\S]*?)```/);
  const code = m ? m[1].trim() : text;
  const el = document.createElement('div'); el.className='mermaid'; el.textContent = code;
  const wrap = $('#mmd'); wrap.innerHTML=''; wrap.appendChild(el);
  mermaid.run({ nodes: [el] });
}
</script>
<style id="csv-scroll-fix">
  #csvWrap { overflow:auto; max-width:100%; }
  #csvWrap table { display:block; overflow-x:auto; white-space:nowrap; width:max-content; min-width:100%; }
</style>
<style id="runbtn-click-fix">
  /* 左ペイン（ステップ列）を前面に */
  #steps { position: relative; z-index: 5; overflow: visible; }

  /* カードとボタンを最前面にしてクリック可能に */
  #steps .card { position: relative; overflow: visible; }
  #steps .runBtn { position: relative; z-index: 10; pointer-events: auto; }
</style>
